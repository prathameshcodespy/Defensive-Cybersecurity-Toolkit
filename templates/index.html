<!DOCTYPE html>
<html>
<head>
    <title>AI Cyber Defense Command Center</title>

    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&display=swap" rel="stylesheet">

    <!-- Leaflet -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

    <style>
        body {
            margin: 0;
            background: #020617;
            color: #00ffff;
            font-family: 'Orbitron', sans-serif;
        }

        h1 {
            text-align: center;
            padding: 20px;
            text-shadow: 0 0 15px #00ffff;
        }

        .container {
            width: 92%;
            margin: auto;
        }

        .card {
            background: rgba(0, 30, 50, 0.95);
            padding: 20px;
            margin: 20px 0;
            border-radius: 14px;
            box-shadow: 0 0 20px rgba(0,255,255,0.2);
        }

        .risk-score {
            font-size: 28px;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% { text-shadow: 0 0 5px #00ffff; }
            50% { text-shadow: 0 0 25px #00ffff; }
            100% { text-shadow: 0 0 5px #00ffff; }
        }

        .logs {
            font-family: monospace;
            max-height: 200px;
            overflow-y: auto;
        }

        #map {
            height: 500px;
            width: 100%;
            border-radius: 10px;
        }

        input, button {
            padding: 8px;
            margin: 5px;
            background: black;
            border: 1px solid #00ffff;
            color: #00ffff;
        }

        button:hover {
            background: #00ffff;
            color: black;
            cursor: pointer;
        }

        .critical { color: red; }
        .high { color: orange; }
        .medium { color: yellow; }
        .low { color: #00ffff; }
    </style>
</head>

<body>

<h1>üõ° AI Cyber Defense Command Center</h1>

<div class="container">

<div class="card">
    System Risk Level:
    <div class="risk-score" id="riskScore">0%</div>
</div>

<div class="card">
    <h2>üì° Global Threat Feed</h2>
    <div class="logs" id="threatLogs"></div>
</div>

<div class="card">
    <h2>üåç Live Global Cyber Attacks</h2>
    <div id="map"></div>
</div>

<div class="card">
    <h2>‚ö° Network Penetration Module</h2>
    <form method="POST">
        Target IP:
        <input type="text" name="target" value="127.0.0.1" required>
        Start Port:
        <input type="number" name="start_port" required>
        End Port:
        <input type="number" name="end_port" required>
        <button type="submit">Execute Scan</button>
    </form>
</div>

{% if results %}
<div class="card">
    <h2>üì° Open Ports</h2>
    <ul>
        {% for port, service in results %}
            <li>Port {{port}} - {{service}}</li>
        {% endfor %}
    </ul>
</div>
{% endif %}

{% if risks %}
<div class="card">
    <h2 style="color:red;">‚ö† Threat Report</h2>
    <ul>
        {% for port, service, reason in risks %}
            <li>{{reason}}</li>
        {% endfor %}
    </ul>
</div>
{% endif %}

</div>

<script>
/* üî• Threat Feed */
async function fetchThreats() {
    const response = await fetch('/api/threats');
    const data = await response.json();

    document.getElementById("riskScore").innerText = data.risk_score + "%";

    const logsDiv = document.getElementById("threatLogs");
    logsDiv.innerHTML = "";

    data.logs.forEach(log => {
        logsDiv.innerHTML += `
            <div class="${log.severity.toLowerCase()}">
                [${log.time}] ${log.attack} | ${log.ip} | ${log.severity}
            </div>
        `;
    });
}
setInterval(fetchThreats, 3000);
fetchThreats();

/* üåç Map Setup (Dark Theme with Country Names) */
const map = L.map('map', {
    center: [20, 0],
    zoom: 2,
    worldCopyJump: true
});

/* Dark Map With Labels */
L.tileLayer(
    'https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png',
    {
        attribution: '&copy; OpenStreetMap & Carto',
        maxZoom: 19
    }
).addTo(map);

/* Curved Arc Generator */
function getCurvedLine(latlng1, latlng2) {
    const latlngs = [];

    const offsetX = latlng2[1] - latlng1[1];
    const offsetY = latlng2[0] - latlng1[0];

    const r = Math.sqrt(Math.pow(offsetX, 2) + Math.pow(offsetY, 2));
    const theta = Math.atan2(offsetY, offsetX);

    const thetaOffset = (3.14 / 10);

    const r2 = (r / 2) / Math.cos(thetaOffset);
    const theta2 = theta + thetaOffset;

    const midpointX = r2 * Math.cos(theta2) + latlng1[1];
    const midpointY = r2 * Math.sin(theta2) + latlng1[0];

    for (let t = 0; t <= 1; t += 0.02) {
        const x = (1 - t) * (1 - t) * latlng1[1]
                + 2 * (1 - t) * t * midpointX
                + t * t * latlng2[1];

        const y = (1 - t) * (1 - t) * latlng1[0]
                + 2 * (1 - t) * t * midpointY
                + t * t * latlng2[0];

        latlngs.push([y, x]);
    }

    return latlngs;
}

/* Random Attack Simulation */
function randomCoord() {
    return [
        Math.random() * 140 - 70,
        Math.random() * 360 - 180
    ];
}

function simulateAttack() {
    const source = randomCoord();
    const target = randomCoord();

    const arc = getCurvedLine(source, target);

    const line = L.polyline(arc, {
        color: 'red',
        weight: 2,
        opacity: 0.8
    }).addTo(map);

    const marker = L.circleMarker(target, {
        radius: 6,
        color: '#00ffff',
        fillOpacity: 1
    }).addTo(map);

    setTimeout(() => {
        map.removeLayer(line);
        map.removeLayer(marker);
    }, 3000);
}

setInterval(simulateAttack, 1200);
</script>

</body>
</html>
